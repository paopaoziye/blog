---
title: Linux内核设计与实现（一）
seo_title: seo名称
toc: true
indent: true
top: false
comments: true
archive: true
cover: false
mathjax: false
pin: false
top_meta: false
bottom_meta: false
sidebar:
  - toc
tag:
  - Linux内核
categories: Linux内核
keywords: 文章关键词
updated: ''
date: ''
img: /medias/featureimages/3.webp
summary: Linux内核基础
---
# Linux内核设计与实现（一）
## Linux内核基础
### 1.Unix和Linux
**1.1Unix系统特点**
①简洁：只有几百个系统调用且设计目的简单明确
②一切皆文件：对数据和设备的操作可以通过同一套接口完成
③C语言编写：移植能力强
④进程创建十分迅速，提供了一套十分简单稳定的进程间通信元语
#Linux是类Unix系统，没有直接使用Unix源码，但是**设计理念一致**且保证了**应用程序编程接口的一致**
**1.2Linux和Unix的差异**
①Linux支持动态加载和卸载内核模块
②Linux支持对称多处理（SMP）机制
③linux内核可以抢占
④Linux不区分进程和线程
⑤Linux提供具有设备类的面向对象的设备模型、热插拔事件
### 2.基本概念
**2.1内核空间**：内核等相关程序运行的空间，拥有**受保护的内存空间**和访问硬件的**所有权利**
**2.2用户空间**：应用程序执行的空间，应用程序在用户空间只能看到系统允许他们使用的部分系统资源，只能使用某些特定的系统功能，不能直接访问硬件，也不能访问内核划分给**其他应用程序的内存空间**
#当内核运行时，系统以内核态进入内核空间，当用户程序运行时，系统以用户态进入用户空间
**2.3系统调用**：应用程序通过系统调用陷入内核，应用程序调用库函数，库函数通过系统调用接口调用**内核子系统/设备驱动程序**
**2.4单内核**：内核以**单个静态二进制文件**的形式存放在磁盘中，运行在一个**单独的地址空间**上，内核之间的通信耗时可忽略不计
**2.5微内核**：内核功能被划分为**多个独立的过程**，每个过程叫做一个**服务器**，每个服务器独立运行在**各自的地址空间**上，除了强烈要求特权服务的服务器运行在特权模式下，其他服务器运行在**用户空间**，每个服务器采用**进程间通信机制**沟通，可靠性更强，一个服务器出现问题不会祸及其他服务器，且服务器**可以加载也可以卸载**
#Linux是**单内核**，但是汲取了微内核的精髓——模块化设计、抢占式内核、支持内核线程及动态装载内核模块
### 3.Linux版本
**[主版本号].[从版本号].[修订版本号].[稳定版本号]**
#稳定版本号是偶数则是稳定版，反之为开发版

### 4.简述编译内核
**4.1获得内核源码**：在[Linux内核官网](http://www.kernel.org)下载
①使用git clone和git pull获得内核源码
②自行下载安装，有bzip2和gzip两种形式，其中bzip2是默认和首选下载格式，采用tar命令解压，解压后的源码在linux-x.y.z.目录下（x.y.z.为Linux版本号）
③安装内核补丁进行版本的更迭
**4.2安装内核源码**：系统本身的内核源码**位于/usr/src/linux目录**下，但是**不能将该源码树用于开发**，因为**编译C库**所用的内核版本链接到该棵树。应该建立**自己的主目录**，仅仅以**root身份**安装新内核到该目录，系统本身目录不进行任何更改
**4.3配置内核**：将自己需要的**特定功能和驱动程序**编进内核（根目录下.config文件），常见内核配置工具如下
①make config
#遍历所有配置项，要求用户选择选项，耗时长，不推荐
②make menuconfig或者make gconfig
#图形界面，推荐
③make defconfig 
#基于默认配置为你的体系结构创建一个配置
④make oldconfig
#根据.config文件生成/更新配置
#配置选项CONFIG_IKCONFIG_PROC将**完整压缩**的配置文件存放在/proc/config.gz下，可以采用zcat /proc/config.gz > .config及make oldconfig克隆当前配置
**4.4编译内核**
①编译内核：make
②减少编译垃圾信息：make > ../detritus或者make > dev/null
#前者将编译信息重定向到该文件中，后者的/dev/null是个永无返回值的黑洞，但是警告和错误信息还是会打印出来
③将编译过程拆分为多个并行的作业：make -jn
#其中n为作业数，一般**每个处理器上衍生出一两个作业**
**4.5安装新内核**：根据启动引导工具的说明操作即可

### 5.内核开发的特点
**5.1不能访问C库及标准C头文件**:对于内核来说，C库**太大且低效**了
#不过大部分常用的C库函数在内核中已经得到了实现，比如string库对应<linux/string.h>
#基本的头文件位于内核源码树**顶级目录的include目录**下
#体系结构相关头文件位于arch/[architecture]/include/asm目录下,以asm为前缀，如<asm/ioctl.h>
**5.2必须使用GUN C**
**5.3没有内存保护机制**：当内核自身发生了内存错误会导致oops
#内核中的内存**不分页**
**5.4不要轻易使用浮点数**：在内核中使用浮点数，不仅仅要人工保存和回复浮点寄存器，还需要一些繁琐的操作
**5.5容积小且固定的栈**：内核栈大小随体系结构改变
**5.6同步和并发**：内核的许多特性要求可以并发的访问共享数据，这就可能产生竞争
**5.7可移植性的重要性**