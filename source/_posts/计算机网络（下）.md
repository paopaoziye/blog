---
title: 计算机网络（下）
seo_title: seo名称
toc: true
indent: true
top: false
comments: true
archive: true
cover: false
mathjax: false
pin: false
top_meta: false
bottom_meta: false
sidebar:
  - toc
tag:
  - 计算机网络
  - 《计算机网络自顶向下》
categories: 计算机基础
keywords: 文章关键词
updated: ''
img: /medias/featureimages/31.webp
date:
summary: 网络层、运输层和应用层
---
# 计算机网络（二）
## 计算机网络进阶
### 1.网络层
#### 1.1概述
**①任务**
>实现**数据包**在**各个网络之间**的传输
{%list%}
通过IP数据报传递源IP地址和目的IP地址等信息
{%endlist%}
**②IP地址**
>**因特网**给**每台主机/路由器的每个接口**分配的**全世界**范围内**唯一的标识符**
{%list%}
主要分为网络号和主机号两部分，前者用于标识不同网络，后者用于标识网络下的不同接口
{%endlist%}
{%right%}
与MAC地址不同，传输过程中，源IP地址和目的ip地址始终保持不变
{%endright%}
>如一个**主机A**经过**路由B**发送给**主机C**，`IP源地址:目的IP地址`在**两段链路**中均为`IPA:IPC`

**③地址解析协议APR**
{%list%}
基于APR协议根据IP地址找到对应的MAC地址
{%endlist%}
>**每台主机**都有一个**APR高速缓存表**，记录了**其他主机**的**IP地址**和**MAC地址**的**对应关系**

>若**发送方**无法在**APR高速缓存表**中**根据IP地址**到**接受方**的**MAC地址**，则发送**请求报文**给**其他所有主机**
{%list%}
请求报文包含了发送方的IP地址和MAC地址，以及接收方的IP地址
{%endlist%}

>**接收方**接收到**请求报文**后，将**发送方的IP地址和MAC地址**记录到自己的**APR高速缓存表**中，并给其发送**响应报文**，**发送方**接受到**响应报文**后其**记录**下来并**使用**
{%list%}
响应报文包含接收方的IP地址和MAC地址
{%endlist%}
{%warning%}
APR协议不能跨网络使用
{%endwarning%}

#### 1.2IP地址应用
{%list%}
以IPv4地址为例
{%endlist%}
**①表示**
>**IPv4地址**本质上是**一串32位的比特**，将**每8位作为一组**，转化为**十进制**并**使用`.`隔开**

**②编址方式**
>**分类编址**：将**IP地址**分为**几类**，**格式不同**，分配给**不同的接口**
{%list%}
主要是网络号和主机号的占比不同，从而导致可指派的网络数量和每个网络可分配的IP地址不同
{%endlist%}
{%warning%}
分类编址并不灵活，导致一些分类使用较少，使得地址无法被充分利用
{%endwarning%}
>**划分子网**：在**分类编址的基础**上，将**主机号的一部分**作为**子网号**
{%list%}
子网掩码的格式决定借用几位作为子网号
{%endlist%}
![子网掩码](/image/JW_6.png)
>**无分类编址**：在**IPv4地址后**加上`/[数字]`，标识**网络号前缀所占比特数量**
{%list%}
依旧通过子网掩码计算对应的网络号
{%endlist%}

**③应用规划**
{%list%}
将IPv4地址块划分为几个小的地址块分配给不同网络
{%endlist%}
>**定长的子网掩码**：使用**同一个子网掩码**划分子网
{%warning%}
每个子网所分配的IP地址数量相同，容易造成IP地址的浪费
{%endwarning%}
>**变长的子网掩码**：使用**不同子网掩码**划分子网
{%list%}
根据每个网络所需的IP地址数量决定主机号位数，从而决定子网掩码的格式
{%endlist%}
{%right%}
子网掩码只是一种划分方法
{%endright%}

#### 1.3IP数据报的传递
**①路由器**
>**路由器**的**不同接口**连接**不同网络**，接口的**IP地址**也被称为**默认网关**
{%list%}
每个路由器都会在路由表中记录其接口的IP地址，即与其相连的网络信息，并将这些信息传递给与之相连的路由器
{%endlist%}
{%right%}
路由器详细记录自身的接口的IP地址信息，粗略记录与之相连的路由器接口的IP地址信息
{%endright%}
>**路由聚合**：记录**其他路由器**的**信息**时，寻找其路由表**所有表项的共同前缀**，并记录在**一个表项中**

![路由聚合](/image/JW_7.png)
**②过程概述**
>若**发送方**和**接收方**处于**同一网络**，**直接转发**即可
{%list%}
将发送方和接收方IP地址与一方地址掩码相与，若结果相同，则两者在同一网络
{%endlist%}
>若两者**不在同一网络**，则在**路由表**中查找**目的网络**，将其**转发**到对应**接口/路由器**，从而传递到**对应网络**
{%list%}
将目的地址，和表项的地址掩码相与，若结果和表项网络地址一致，则找到目的网络
{%endlist%}
![IP数据报的传递](/image/JW_8.png)
#### 1.4路由选择协议
**①引言**
{%right%}
为了实现信息在路由器之间传递，需要向路由表中填充信息，包含目的网络地址、对应接口和辅助信息
{%endright%}
>**静态路由配置**：**人工配置**网络路由
{%list%}
开销小，但是不能及时适应网络状态变化，一般只在小规模网络中使用
{%endlist%}
>**动态路由配置**：通过**路由选择协议**自动获取**路由信息**
{%list%}
将因特网分为多个自治系统AS，系统内采用内部网关协议进行路由选择，系统之间采用外部网关协议进行路由选择
{%endlist%}
**②路由信息协议RIP**
{%list%}
一种内部网关协议，将路由器到直连网络的距离定义为1，到非直连网络的距离定义为经过的路由器数目加一
{%endlist%}
>**一开始**，路由器只知道**自己到直连网络的距离**为`1`

>**每个路由器**和**相邻路由器**周期性**交换信息**并**更新路由表**
{%right%}
当接收到的路由信息中，有新的/更好的路由信息，则添加/替换
{%endright%}
>经过**若干次交换和更新**后，**每个路由器**都知道**到达本AS内各个网络的最短距离**和**下一跳地址**

**③开放最短路径优先OSPF协议**
{%list%}
一种内部网关协议，用某一指标（距离、带宽和时延等）描述链路
{%endlist%}
{%list%}
为了适应更大的网络，可以将AS划分为更小的区域进行管理
{%endlist%}
>**每个路由器**都会记录其**相邻路由器**，并通过**周期性发送问候分组**维护

>**每个路由器**将其到**直连网络**和**邻居路由器**的**链路状态（LSA）**发送给**其他所有路由器**

>**每个路由器**都有一个**数据链路状态库LSDB**存储**LSA**，最后**LSDB**将存储**所有链路信息**

>**每个路由器**基于**LSDB**进行**最短路径优先**计算，构建出**各自到达其他路由器的最短路径**，从而构建各自的**路由表**

**④边界网关协议BGP**
{%list%}
一种外部网关协议，由于不同的AS路由度量标准不一，只能尽力寻找一条能达到目的AS的相对较好的路由
{%endlist%}
>**每个AS**都有**一个路由器**作为**BGP发言人**，**不同的AS**通过各自的**BGP发言人**连接
{%list%}
BGP发言人除了运行BGP协议，还需要运行其所在AS的内部网关协议
{%endlist%}
>**BGP发言人**之间通过建立**TCP连接**交换**路由信息**，并从中找出**到达各自自治系统**的**不存在回路**的路由
#### 1.5虚拟专用网

### 2.运输层
#### 2.1概述
**①任务**
>为运行在**不同主机**上的**进程**提供直接的**通信服务**
{%list%}
网络通信的最终实体还是进程而非主机
{%endlist%}
**②端口号**
{%list%}
由于不同操作系统的进程标识符不同，故统一采用16比特的端口号区分不同进程
{%endlist%}
{%warning%}
端口号只有本地意义，不同计算机的相同端口号没有联系
{%endwarning%}
>**熟知端口号**：`0~1023`，分配给了TCP/IP体系中**最重要的应用协议**，如**HTTP**使用`80`，**DNS**使用`53`

>**登记端口号**：`1024~49151`，为**没有熟知端口号**的**应用程序（windows桌面应用）**使用，需要**在IANA机构登记**以防止重复

>**短暂端口号**：`49152~65535`，留给**客户进程（如浏览器）**选择**短暂使用**，

**③UDP和TCP**
>**UDP协议**：支持**单播**、**多播**和**广播**，可以**随时**发送数据，提供**不可靠传输**服务

>**TCP协议**：**仅仅**支持**单播**，需要**先建立连接**然后**发送数据**，**发送完数据**后还需要**释放连接**，提供**可靠传输**服务
{%list%}
UDP以应用报文为单位进行封装，而TCP将应用报文划分为多个字节流，从发送缓存取出一部分或全部字节进行封装
{%endlist%}
**④TCP报文段首部格式**
>**源端口**：标识**发送**TCP报文段的**进程**

>**目的端口**：标识**接收**TCP报文段的**进程**

>**序号**：指出TCP报文段**数据载荷第一个字节**的**序号**
{%list%}
该序号指的时其再所有数据中的位置，而不是在TCP报文段的位置
{%endlist%}
>**确认号**：指出**期望接收**到对方**下一个TCP报文段的数据载荷第一个字节的序号**
{%list%}
同时也是对之前受到数据的确认，若确认号为n，表示序号为n-1前的数据都被正确接收
{%endlist%}
>**ACK**：当该位为`1`，**确认号有效**，若为`0`，则**无效**

>**SYN**：TCP**建立连接**时**同步序号**

>**FIN**：用于**释放TCP连接**，为`1`时表示为**TCP连接释放报文段**

>**RST**：用于**复位TCP连接**，为`1`时表示**TCP连接出现异常**，需要**释放连接并重新建立**
{%list%}
RST置1还可用于拒绝一个非法的报文段或者拒绝打开一个TCP连接
{%endlist%}
>**窗口**：指出**发送方**的**接收窗口长度**

>**填充字段**：由于有些内容**长度可变**，需要使用填充**使报文段首部能被4整除**
#### 2.2TCP连接
**①创建**
>**被请求方**首先**创建传输控制块**，随后进入**监听状态**，称为**被动打开连接**
{%list%}
用于存储TCP连接的重要信息，如TCP连接表等
{%endlist%}
>**请求方**建立**传输控制块**，随后发送**TCP连接请求报文段**，并进入**同步已发送状态**，称为**主动打开连接**
{%list%}
TCP连接请求报文段SYN被置为1，表明为TCP连接请求报文段，不能携带数据，序号初始化为x
{%endlist%}
>**被请求方**接收到**TCP连接请求报文段**后，如果**同意建立连接**，则发送**TCP连接请求确认报文段**，进入**同步已接收状态**
{%list%}
该报文段SYN和ACK置为1，确认号为x+1，表示对TCP连接请求报文段的确认，序号初始化为y
{%endlist%}
>**请求方**接收到**TCP连接请求确认报文段**后，发送**二次确认报文段**，进入**连接建立状态**，**被请求方**接收到**二次确认报文段**之后也进入**连接建立状态**
{%list%}
该报文段ACK置为1，确认号为y+1，表示对TCP连接请求确认报文段的确认，序号被设为x+1
{%endlist%}
{%right%}
二次确认报文段用于防止失效的TCP连接请求报文段突然又传送到被接受方，导致其进入同步已接受状态，引发错误
{%endright%}
![TCP连接的建立](/image/JW_9.png)
**②释放**
{%list%}
两方都可释放连接，以请求方主动释放连接为例
{%endlist%}
>**请求方**发送**TCP连接释放报文段1**，进入**终止等待1状态**
{%list%}
该报文段FIN，ACK置1，声明其为TCP连接释放报文段1，设置序号u以及确认号为v
{%endlist%}
>**被请求方**接收到**TCP连接释放报文段1**之后，发送**TCP确认报文段1**，并进入**关闭等待状态**
{%list%}
该报文段ACK置1，设置序号v以及确认号u+1
{%endlist%}
>**请求方**接收到**TCP确认报文段1**之后，进入**终止等待2状态**
{%list%}
此时被请求方还能向请求方发送数据
{%endlist%}
>**被请求方完成数据通信**，进程通知其**释放连接**，发送**TCP连接释放报文段2**，并进入**最后确认状态**
{%list%}
该报文段FIN，ACK置1，设置序号w，因为可能又发送了一些数据，设置确认号u+1，对一开始的重复确认
{%endlist%}
>**请求方**接收到**TCP连接释放报文段2**后，发送**TCP确认报文段**，等待**2倍MSL时间**后进入**关闭状态**，**被请求方**接收到**TCP确认报文段2**后进入**关闭状态**
{%list%}
该报文段ACK置1，设置序号u+1以及确认号w+1，对TCP连接释放报文段2进行确认
{%endlist%}
{%right%}
MSL为最长报文寿命，等待这么长时间防止确认报文段丢失
{%endright%}
![TCP连接的释放](/image/JW_11.png)
#### 2.3TCP功能
**①流量控制**
>**控制**发送方的**发送速率**，**便于**接收方**接收**
{%list%}
接收方根据自己接收窗口的大小动态调整发送方的发送窗口，只有落入发送窗口的数据可以被发送
{%endlist%}
**②拥塞控制**
{%list%}
拥塞指网络中某一资源供不应求，会导致网络的性能下降，使用拥塞窗口限制发送窗口大小
{%endlist%}
{%right%}
发送窗口通常取拥塞窗口和接收窗口的小值
{%endright%}
>**慢开始**：**一开始**,**拥塞窗口**大小为`1`，并随着**发送轮次**的**增大**而**指数级增大**

>**拥塞避免**：当**拥塞窗口**增大到**慢开始门限**，不再**指数级增长**，改为**线性增长**
{%list%}
当重传计时器超时，即视为拥塞，慢开始门限变为拥塞时拥塞窗口的一半，并将拥塞窗口变为1，重新开始以上流程
{%endlist%}
{%warning%}
然后，重传计时器超时可能并不代表拥塞，而是对应报文丢失，会降低网络的性能
{%endwarning%}
>**快重传**：**接收方**一旦**接收到数据**就**立即**发送对应的**确认分组**，即使收到了**失序的分组**，当**重复**收到**同一个分组的三个确认分组**，**立即重传**
{%right%}
排除了其他原因导致的重传计时器超时
{%endright%}
>**快恢复**：执行**快重传**后，**慢开始门限**和**拥塞窗口**调整为**当前窗口的一半**，并执行**拥塞避免算法**

![拥塞控制](/image/JW_10.png)
**③超时重传**
>**重传时限**最好**略大于**数据的**往返时间RTT**
{%list%}
不同数据经过的网络不同，往返时间也不同，将每次测量的到的RTT样本加权计算并更新平均往返时间RTT
{%endlist%}
{%warning%}
报文段重传会导致样本失效，若仅仅丢弃该样本，可能导致重传时限无法更新导致被反复重传
{%endwarning%}
{%right%}
所以每次报文段重传适当增大重传时限
{%endright%}
**④可靠传输**
>**发送方**：只有落入**发送窗口**的**字节**才能被**发送**，当收到了**新的确认分组**，**发送窗口后沿向前移动**到**确认号位置**，若**重复收到三次同样的确认号**，则**重发对应的字节**
{%list%}
发送窗口前沿会受到后沿和窗口大小的影响，可能向前移动，不动甚至是收缩
{%endlist%}
>**接收方**：只有落入**接收窗口**的**字节**才能被**接收**，每当**收到数据**，会发送**确认分组**，确认号为**最小的失序字节序号**
{%right%}
易知可靠传输主要依靠接收方的确认分组实现，所以除了每次收到数据，每隔一段时间也要发送确认分组
{%endright%}
### 3.应用层
#### 3.1引言
**①任务**
>通过**应用进程的交互**，实现**特定网络应用**，也是**设计和建设计算机网络**的**最终目的**

**②进程关系**
>**客户/服务器方式**：进程分为**客户端**和**服务器端**，**客户端**向**服务器端请求服务**，**服务器端收到请求后**为其**提供服务**
{%list%}
服务器端总是处于运行状态，并具有固定的端口号，等待客户端的请求
{%endlist%}
>**对等方式**：各个进程是**对等的**，既**请求服务**，也**提供服务**
{%right%}
可扩展性好，成本低
{%endright%}

#### 3.2域名系统DNS
{%right%}
将域名转化为IP地址，这样就可以通过便于记忆的域名寻找对应主机了
{%endright%}
**①域名结构**
>由**多级域名**组成，**级别越低**的域名写在**越左边**，使用`.`**隔开**

>**顶级域名**：**国家顶级域名**、**通用顶级域名**和**反向域**
{%list%}
如cn表示中国，com表示企业公司，org表示非营利性组织
{%endlist%}
>**二级域名**：由**国家自行决定**，我国将其分为**类别域名**和**行政区域名**两大类
{%list%}
二级域名以下还能层层划分，表现为一种树形结构
{%endlist%}
**②域名服务器**
>**根域名服务器**：记录所有**顶级域名服务器**的**域名**以及**IP地址**
{%list%}
二级域名以下还能层层划分，表现为一种树形结构
{%endlist%}
>**顶级域名服务器**：记录再**该顶级域名服务器**注册的所有**二级域名**

>**权限域名服务器**：记录**某个区域**的**所有主机**的域名

>**本地域名服务器**：当**一个主机**发出**DNS请求**时，先传送到**本地域名服务器**，由其**转发**到**以上三种服务器**中
{%list%}
本地域名服务器起到代理的作用，需要直接配置在使用该域名服务器的主机上
{%endlist%}
**③工作原理**
>当访问**域名**时，**用户主机**会在**自己的DNS高速缓存**中寻找域名**对应的IP地址**

>若没有，发送**DNS查询报文**给**本地域名服务器**，**本地域名服务器**在**上述三种域名服务器**找到**对应域名**后返回给**主机**
{%list%}
本地域名服务器向上层的查询方式可分为递归查询和迭代查询两种，递归查询代价太大，简单介绍迭代查询
{%endlist%}
>**本地域名服务器**先向**根域名服务器**查询，得到对应的**顶级域名服务器**地址，随后从对应**顶级域名服务器**获得对应**权限域名服务器**地址，最后从**权限域名服务器**查找到**目的域名的IP地址**

#### 3.3电子邮件
**①组成**
>**用户代理**：**用户**与**电子邮件系统**的接口，即**客户端软件**

>**邮件服务器**：**电子邮件系统**的**基础设施**，用于**发送**和**接收邮件**，并**维护用户的邮箱**
{%list%}
邮件服务器可以看做为多个邮箱的集合
{%endlist%}
**②工作原理**
>**发送方**使用**用户代理**通过**邮件发送协议**向**发送方邮件服务器**发送邮件

>**发送方邮件服务器**通过**邮件发送协议**向**接收方邮件服务器**发送邮件
{%list%}
常用的邮件发送协议为SMTP，两方建立TCP连接后，通过SMTP命令和应答报文段实现通信
{%endlist%}
{%warning%}
SMTP协议只能传送ASCLL码文本数据，不能传送二进制对象
{%endwarning%}
{%right%}
可以通过MIME协议将非ASCLL码数据转化为ASCLL码数据，再使用SMTP协议进行传输
{%endright%}
>**接收方**使用**用户代理**通过**邮件接收协议**从**接收方邮件服务器**读取邮件
{%list%}
邮件读取协议有POP和IMAP，前者只能从邮件服务器下载文件，后者可以在自己的计算机上操控邮件服务的邮箱
{%endlist%}
{%right%}
若发送时采用了MIME，接收时也需要使用MIME将ASCLL码文本数据转化为非ASCLL码文本数据
{%endright%}
#### 3.4万维网
**①引言**
>**定义**：一个**大规模**、**联机式**的**信息储藏所**，是运行在因特网上的一个**分布式应用**
{%list%}
HTML文档描述网页的结构和内容，CSS文档描述网页的样式，JavaScript文档控制网页的行为
{%endlist%}
>**网页基本组成**：**HTML文档**、**CSS文档**、**JavaScript文档**以及一些**资源文件（如图片）**
{%list%}
HTML文档描述网页的结构和内容，CSS文档描述网页的样式，JavaScript文档控制网页的行为
{%endlist%}

>**URL资源定位符**：指明**资源的位置**，**格式**为`[协议]://[主机]:[端口]/[路径]`

**②HTTP协议**
>**定义**：万维网**客户端**和**服务端**的**通信格式**
{%list%}
客户端和服务端首先建立TCP连接，客户端向服务端发送请求报文，服务端返回响应报文
{%endlist%}
>**请求报文**：主要由**一个请求行**和**多个首部行**组成，以**换行结尾（很少会在换行后跟实体主体）**
{%list%}
请求行指明方法、URL和HTTP版本，首部行指明请求细节
{%endlist%}
>**响应报文**：由**一个状态行**和**多个首部行**，以**换行结尾（有时会在换行后跟实体主体）**
{%list%}
状态行表明返回结果，如接受请求、请求错误或找不到页面等，首部行和请求报文对应
{%endlist%}
**③工作原理**
>在**浏览器中输入域名**，**客户端**和**服务端**建立**TCP连接**，客户端发送**HTTP请求报文**给对应的**服务端**，**服务端**返回**HTTP响应报文**，**浏览器**对**HTTP响应报文**进行**解析**，获得**网站内容**
{%list%}
浏览器的内核是渲染引擎，不同浏览器的显示效果不同
{%endlist%}
{%right%}
将最近的一些请求和响应存放在web缓存中，若新请求与web缓存某请求相同，直接返回对应的响应，不再建立连接
{%endright%}
**④Cookie**
{%list%}
对无状态的HTTP进行状态化
{%endlist%}
>当**用户**的浏览器进程**首次**向**某网页服务端**发送**HTTP请求报文**，**该网页服务端**会创建一个**cookie识别码**并**记录用户访问该网站的各种信息**

>**该网页服务端**通过**HTTP响应报文**传回该**Cookie识别码**，**客户端**将其记录在对应的**Cookie文件**中

>下次用户**再访问该网页**，会向**HTTP请求报文**中添加对应的**Cookie识别码**，**网页服务端**识别**Cookie识别码**后**根据记录信息**返回**特定的网页**

#### 3.5其他常见协议
**①动态主机配置协议DHCP**
{%right%}
各个主机从DHCP服务器请求IP地址、子网掩码、默认网关等网络配置信息
{%endright%}
>**DHCP客户端**广播发送**DHCP发现报文**，其中包含**事务ID**和**客户端的MAC地址**
{%list%}
因为DHCP客户并不知道网络中有多少个DHCP服务器，故广播发送
{%endlist%}
>**DHCP服务器端**接收到**DHCP发现报文**之后，根据**客户端的MAC地址**查找从**数据库**中查找对应的**配置信息**，如果**没有找到**则采用**默认配置信息**，并**广播**发送**DHCP提供报文**，其中包含**事务ID**和**网络配置信息**
{%list%}
服务端会采用ARP协议检测分配的IP是否被占用再分配
{%endlist%}
>**客户端**接收**DHCP提供报文**，并根据**事务ID**判断**是否属于自己**，若属于，则**接收并使用**其中**配置信息**
{%list%}
若网络中有多个DHCP服务端，则可能受到多个DHCP提供报文，选择最先到达的
{%endlist%}
>**DHCP客户端**广播发送**DHCP请求报文**，其中包含**事务ID**、**客户端的MAC地址**和**选择的服务端的IP地址**等信息

>**选择的DHCP服务端**广播发送**DHCP确认报文**，**客户端**接收后就**可以使用相关网络配**置了
{%list%}
服务端向客户端发送报文均采用广播发送，因为直到现在客户端才有自己的IP地址
{%endlist%}
**②文件传送协议FTP**
{%right%}
提供交互式的访问，允许客户指明文件的类型与格式，并允许文件有存取权限
{%endright%}
>**FTP客户端**和**FTP服务端**建立**TCP连接**，并传输**FTP相关控制命令**

>当两者**有数据需要传输时**，再**另外**建立一个**TCP连接**作为**数据通道**
{%list%}
FTP常常用于在计算机之间批量传输文件，如XFTP软件
{%endlist%}